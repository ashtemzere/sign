name: Sign IPA (Auto-Find Fix)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct Link to IPA'
        required: true

jobs:
  sign-ipa:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Smart Build Zsign
        run: |
          # 1. دابەزاندنی بەرنامە پێویستەکان
          sudo apt-get update
          sudo apt-get install -y libssl-dev g++ git

          # 2. هێنانی فایلەکان (Clone)
          rm -rf zsign_repo
          git clone --depth 1 https://github.com/zhlynn/zsign.git zsign_repo
          
          # 3. گەڕان بەدوای فایلەکەدا (گرنگترین بەش)
          # ئەم کۆدە خۆی دەگەڕێت بزانێت zsign.cpp لە کوێیە
          SRC_DIR=$(find zsign_repo -name "zsign.cpp" -exec dirname {} \;)
          
          if [ -z "$SRC_DIR" ]; then
            echo "Error: فایلەکان نەدۆزرانەوە، تکایە دڵنیابە ئینتەرنێت هەیە."
            exit 1
          fi
          
          echo "Source found in: $SRC_DIR"
          cd "$SRC_DIR"

          # 4. دروستکردنی بەرنامەکە
          g++ *.cpp common/*.cpp -lcrypto -O3 -o zsign_tool
          
          # 5. گواستنەوەی بۆ شوێنی سەرەکی
          mv zsign_tool ../../zsign
          cd ../..
          chmod +x zsign
          ./zsign -v

      - name: Prepare Certificates
        env:
          P12_BASE64: ${{ secrets.P12_FILE }}
          MOV_BASE64: ${{ secrets.PROVISION_FILE }}
        run: |
          echo $P12_BASE64 | base64 -d > certificate.p12
          echo $MOV_BASE64 | base64 -d > profile.mobileprovision

      - name: Download IPA
        run: |
          wget -O original.ipa "${{ github.event.inputs.ipa_url }}"

      - name: Sign App
        env:
          PASS: ${{ secrets.CERT_PASSWORD }}
        run: |
          ./zsign -k certificate.p12 -p "$PASS" -m profile.mobileprovision -o signed_app.ipa -z 9 original.ipa

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: signed_app.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
